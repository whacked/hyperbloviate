<html>
    <body>
        <style>
        * {
            margin: 0;
            padding: 0;
        }

        #main-container {
            width: 100%;
            height: 100%;
        }
        webview {
            width: 100%;
            height: 100%;
            display: none;
        }
        .to-inject {
            display: none;
        }
        </style>

        <div id="main-container"></div>
        <div id="inject-container" class="to-inject">
          <h1>injected dom element</h1>
        </div>

        <!-- server side libs -->
        <script type="text/javascript">
            var fs = require("fs"),
                path = require("path"),
                cheerio = require("cheerio"),
                chokidar = require("chokidar"),
                domutils = require("domutils"),
                express = require("express");
            // sibilant = require("");
        </script>

        <!-- client side libs -->
        <script type="text/javascript" src="node_modules/jquery/dist/jquery.min.js"></script>
        <script type="text/javascript" src="node_modules/immutable/dist/immutable.min.js"></script>
        <script type="text/javascript" src="node_modules/mithril/mithril.min.js"></script>

        <script type="text/javascript" src="node_modules/golden-layout/dist/goldenlayout.min.js"></script>
        <link type="text/css" rel="stylesheet" href="node_modules/golden-layout/src/css/goldenlayout-base.css" />
        <link type="text/css" rel="stylesheet" href="node_modules/golden-layout/src/css/default-theme.css" />

        <script type="text/javascript" src="node_modules/sibilant/lib/browser.js"></script>

        <!-- compiled sibilant
            sibilant compiled.sibilant -m -o .
        -->
        <script type="text/javascript" src="compiled.js"></script>
        <script type="text/sibilant" src="dynamic.sibilant"></script>
        <script type="text/sibilant">
        (console.log "sibilant from browser")
        </script>

        <!-- client side init -->
        <script type="text/javascript">
            /* doesn't work, although there may be a nightly that does
            $("webview").each(function(i, wv) {
                wv.addEventListener("loadstart", function(evt) {
                    console.log("started")
                })
            });
            */
            $(function() {
                // sibilant preprocessor
                $("script[type$='text/sibilant']").each(function(i, el) {
                    if(el.src) {
                        var filepath = el.src.substring(chrome.runtime.getURL("/").length);
                        fs.readFile(filepath, "utf8", function(err, sibcode) {
                            if(err) {
                                console.error(err);
                                return;
                            }
                            eval(sibilant.sibilize(sibcode));
                        });
                    } else {
                        eval(sibilant.sibilize(el.innerText));
                    }
                });

                var config = {
                    content: [{
                        type: 'row',
                        content:[{
                            type: 'column',
                            content:[{
                                type: 'component',
                                componentName: 'regular-component',
                                componentState: { label: 'regular component label' }
                            },{
                                type: 'component',
                                componentName: 'dom-component',
                                componentState: {  }
                            }]
                        },
                                 {
                                     type: 'component',
                                     componentName: 'dom-id-component',
                                     componentState: { id: "inject-container" }
                                 }]
                    }]
                };

                var user_agent = "Mozilla/5.0 (Windows NT 6.1; WOW64; Trident/7.0; AS; rv:11.0) like Gecko";

                var control = document.createElement("div");
                control.innerHTML = "hello!";

                var main_layout = new GoldenLayout(config, document.getElementById("main-container"));
                main_layout.registerComponent("regular-component", function(container, componentState) {
                    container.getElement().html('hello from ' + componentState.label);
                });
                main_layout.registerComponent("dom-component", function(container, componentState) {
                    var aux = document.createElement("webview");
                    aux.useragent = user_agent;
                    aux.src = "https://ddg.gg";
                    container.getElement().html(aux);
                });
                main_layout.registerComponent("dom-id-component", function(container, componentState) {
                    container.getElement().html(document.getElementById(componentState.id));
                });
                main_layout.init();

                $(".to-inject").show();
                $("webview").show();
            });
        </script>

        <script type="text/javascript">
        require("nw.gui").Window.get().showDevTools();

        function get_webview(wv_idx) {
            wv_idx = wv_idx || 0;
            var wvs = $("webview");
            if(wvs.length == 0) {
                return;
            }
            return wvs[wv_idx];
        }

        function execjs(wv, js, cb) {
            if(!wv) { return; }
            wv.executeScript({code:js}, cb ? cb(res) : function(res){
                console.log(res[0])
            });
        }

        function get_webview_html(wv_idx) {
            execjs(get_webview(wv_idx), "document.body.innerHTML");
        }

        function clear_webview_event_listeners(wv_idx) {
            execjs(get_webview(wv_idx), "document.body.outerHTML = document.body.outerHTML");
        }

        function attach_webview_event_listeners(wv_idx) {
            execjs(get_webview(wv_idx), "document.body.addEventListener('click', function(evt) {console.log(evt)})");
        }

        function javascript_handler(obj, callback) {
            console.log("%c GOT JAVASCRIPT ", "color:gray;background:gold;");
            console.log(obj);
            console.log('=============================');
            var rtn = eval.apply(null, [obj]);
            console.log('=============================');
            callback(undefined, rtn);
        }

        function sibilant_handler(obj, callback) {
            console.log("%c GOT SIBLANT ", "color:red;background:black;");
            console.log(obj);
            console.log('=============================');
            var rtn = eval.apply(null, [sibilant.sibilize(obj)]);
            console.log('=============================');
            callback(undefined, rtn);
        }

        var JRPC_PORT = 8002;

        server = null;
        function start_server() {
            if(server) {
                return;
            }
            console.log("%c check panel! ", "color:lime;font-weight:bold;background:black;");
            var jsonrpc = require('multitransport-jsonrpc');
            var Server = jsonrpc.server;
            var ServerMiddleware = jsonrpc.transports.server.middleware;
                  
            var express = require('express');
            var bodyParser = require('body-parser');
                  
            var app = express();
            app.use(bodyParser.json());
            var jsonRpcMiddlewareServer = new Server(new ServerMiddleware(), {
                javascript: javascript_handler,
                sibilant: sibilant_handler
            });
            app.use('/rpc', jsonRpcMiddlewareServer.transport.middleware);
            server = app.listen(JRPC_PORT);
        }

        function stop_server() {
            server.close();
        }
        </script>
    </body>
</html>
