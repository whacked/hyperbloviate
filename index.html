<html>
    <body>
        <style>
        * {
            margin: 0;
            padding: 0;
        }

        #main-container {
            width: 100%;
            height: 100%;
        }
        webview {
            width: 100%;
            height: 100%;
            display: none;
        }
        .to-inject {
            display: none;
        }
        </style>

        <div id="main-container"></div>
        <!-- <webview id="inject-container" class="to-inject" src="https://kindle.amazon.com"></webview> -->
        <div id="inject-container" class="to-inject" src="https://kindle.amazon.com">
          <h3>temp</h3>
        </div>
        <div id="control-container" class="to-inject">control container</div>

        <!-- server side libs -->
        <script type="text/javascript">
            var fs = require("fs"),
                path = require("path"),
                cheerio = require("cheerio"),
                chokidar = require("chokidar"),
                domutils = require("domutils"),
                express = require("express");
            // sibilant = require("");
        </script>

        <!-- client side libs -->
        <script type="text/javascript">
            try {
                require("nw.gui").Window.get().showDevTools();
            } catch(err) {
                // electron;
            }
        </script>

        <!--
        won't work for electron
        <script type="text/javascript" src="node_modules/jquery/dist/jquery.min.js"></script>
        -->
        <script type="text/javascript" src="node_modules/immutable/dist/immutable.min.js"></script>
        <script type="text/javascript" src="node_modules/mithril/mithril.min.js"></script>
        <!-- required for electron -->
        <script type="text/javascript">
            window.m = require("./node_modules/mithril/mithril.min.js");
            window.$ = window.jQuery = require('./node_modules/jquery/dist/jquery.min.js');
        </script>
        <script type="text/javascript" src="node_modules/golden-layout/dist/goldenlayout.min.js"></script>
        <link type="text/css" rel="stylesheet" href="node_modules/golden-layout/src/css/goldenlayout-base.css" />
        <link type="text/css" rel="stylesheet" href="node_modules/golden-layout/src/css/default-theme.css" />

        <script type="text/javascript" src="node_modules/sibilant/lib/browser.js"></script>

        <!-- compiled sibilant
            sibilant compiled.sibilant -m -o .
        -->
        <script type="text/javascript" src="compiled.js"></script>
        <script type="text/sibilant" src="dynamic.sibilant"></script>
        <script type="text/sibilant">
        (console.log "sibilant from browser")
        </script>

        <script id="js-ext" type="text/javascript">
https://github.com/rishihahs/domtalk/blob/master/index.js
function domPath(element) {
        // Top level elements are body and ones with an id
        if (element === document.documentElement) {
            return ':root';
        } else if (element.tagName && element.tagName.toUpperCase() === 'BODY') {
            return 'body';
        } else if (element.id) {
            return '#' + element.id;
        }

        var parent = element.parentNode;
        var parentLoc = domPath(parent);

        // See which index we are in parent. Array#indexOf could also be used here
        var children = parent.childNodes;
        var index = 0;
        for (var i = 0; i < children.length; i++) {
            // nodeType is 1 if ELEMENT_NODE
            if (children[i].nodeType === 1) {
                if (children[i] === element) {
                    break;
                }

                index++;
            }
        }

        return parentLoc + ' *:nth-child(' + (index + 1) + ')';
    }
        </script>


        <!-- client side init -->
        <script type="text/javascript">
            /* doesn't work, although there may be a nightly that does
            $("webview").each(function(i, wv) {
                wv.addEventListener("loadstart", function(evt) {
                    console.log("started")
                })
            });
            */

        var checkjq = setInterval(function() {
            if(!$) {
                console.log('non');
                return;
            }
            clearInterval(checkjq);
            console.log($);
            $(function() {
                // sibilant preprocessor
                $("script[type$='text/sibilant']").each(function(i, el) {
                    if(el.src) {
                        try {
                            var baselen = chrome.runtime.getURL("/").length;
                        } catch(err) {
                            var baselen = path.dirname(document.baseURI).length + 1;
                        }
                        var filepath = el.src.substring(baselen);
                        console.log(filepath);
                        fs.readFile(filepath, "utf8", function(err, sibcode) {
                            if(err) {
                                console.error(err);
                                return;
                            }
                            eval(sibilant.sibilize(sibcode));
                        });
                    } else {
                        eval(sibilant.sibilize(el.innerText));
                    }
                });

                var config = {
                    content: [{
                        type: 'row',
                        content:[{
                            type: 'column',
                            content:[{
                                type: 'component',
                                componentName: 'dom-id-component',
                                componentState: { id: "inject-container" }
                            },{
                                type: 'component',
                                componentName: 'dom-component',
                                componentState: {  }
                            }]
                        },
                                 {
                                     type: 'component',
                                     componentName: 'control-component',
                                     componentState: { id: 'control-container' }
                                 }
                                ]
                    }]
                };

                var user_agent = "Mozilla/5.0 (Windows NT 6.1; WOW64; Trident/7.0; AS; rv:11.0) like Gecko";

                var control = document.createElement("div");
                control.innerHTML = "hello!";

                var main_layout = new GoldenLayout(config, document.getElementById("main-container"));
                main_layout.registerComponent("control-component", function(container, componentState) {
                    container.getElement().html(document.getElementById(componentState.id));
                });
                main_layout.registerComponent("dom-component", function(container, componentState) {
                    var aux = document.createElement("webview");
                    aux.useragent = user_agent;
                    aux.src = "https://ddg.gg";
                    container.getElement().html(aux);
                });
                main_layout.registerComponent("dom-id-component", function(container, componentState) {
                    container.getElement().html(document.getElementById(componentState.id));
                });
                main_layout.init();

                $(".to-inject").show();
                $("webview").show();
            });
        
        }, 50);

        </script>

        <script type="text/javascript">
        function get_webview(wv_idx) {
            wv_idx = wv_idx || 0;
            var wvs = $("webview");
            if(wvs.length == 0) {
                return;
            }
            return wvs[wv_idx];
        }

        function execjs(wv, js, cb) {
            if(!wv) { return; }
            wv.executeScript({code:js}, cb ? cb(res) : function(res){
                console.log(res[0])
            });
        }

        function get_webview_html(wv_idx) {
            execjs(get_webview(wv_idx), "document.body.innerHTML");
        }

        function clear_webview_event_listeners(wv_idx) {
            execjs(get_webview(wv_idx), "document.body.outerHTML = document.body.outerHTML");
        }

        function attach_webview_event_listeners(wv_idx) {
            execjs(get_webview(wv_idx), "document.body.addEventListener('click', function(evt) {console.log(evt.target); console.log(domPath(evt.target))})");
        }

        function javascript_handler(obj, callback) {
            console.log("%c GOT JAVASCRIPT ", "color:gray;background:gold;");
            console.log(obj);
            console.log('=============================');
            var rtn = eval.apply(null, [obj]);
            console.log('=============================');
            callback(undefined, rtn);
        }

        function sibilant_handler(obj, callback) {
            console.log("%c GOT SIBLANT ", "color:red;background:black;");
            console.log(obj);
            console.log('=============================');
            var rtn = eval.apply(null, [sibilant.sibilize(obj)]);
            console.log('=============================');
            callback(undefined, rtn);
        }

        var JRPC_PORT = 8002;

        server = null;
        function start_server() {
            if(server) {
                return;
            }
            console.log("%c check panel! ", "color:lime;font-weight:bold;background:black;");
            var jsonrpc = require('multitransport-jsonrpc');
            var Server = jsonrpc.server;
            var ServerMiddleware = jsonrpc.transports.server.middleware;
                  
            var express = require('express');
            var bodyParser = require('body-parser');
                  
            var app = express();
            app.use(bodyParser.json());
            var jsonRpcMiddlewareServer = new Server(new ServerMiddleware(), {
                javascript: javascript_handler,
                sibilant: sibilant_handler
            });
            app.use('/rpc', jsonRpcMiddlewareServer.transport.middleware);
            server = app.listen(JRPC_PORT);
        }

        function stop_server() {
            server.close();
        }

        start_server();

          function inject_js_ext() {
              execjs(get_webview(0), $("#js-ext").html());
              execjs(get_webview(1), $("#js-ext").html());
          }
          
        </script>
    </body>
</html>
