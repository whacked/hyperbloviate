<html>
    <body>
        <style>
        * {
            margin: 0;
            padding: 0;
        }

        #main-container {
            width: 100%;
            height: 100%;
        }
        webview {
            width: 100%;
            height: 100%;
            display: none;
        }
        .to-inject {
            display: none;
        }
        </style>

        <div id="main-container"></div>
        <!-- <webview id="inject-container" class="to-inject" src="https://kindle.amazon.com"></webview> -->
        <div id="inject-container" class="to-inject" src="https://kindle.amazon.com">
          <h3>temp</h3>
          <button id="test-button">send</button>
          
          <button onclick="get_webview().openDevTools()">openDevTools</button>
          <button onclick="get_webview().closeDevTools()">closeDevTools</button>
          <button onclick="attach_webview_event_listeners()">inject</button>
        </div>
        <div id="control-container" class="to-inject">control container</div>

        <!-- server side libs -->
        <script type="text/javascript">
            var fs = require("fs"),
                path = require("path"),
                cheerio = require("cheerio"),
                chokidar = require("chokidar"),
                domutils = require("domutils"),
                express = require("express");
            // sibilant = require("");
          const {ipcRenderer} = require("electron");
        </script>

        <!-- client side libs -->
        <script type="text/javascript">
            try {
                require("nw.gui").Window.get().showDevTools();
            } catch(err) {
                // electron;
            }
          var common = require("./common"),
              Const = common.Const;
        </script>

        <!--
        won't work for electron
        <script type="text/javascript" src="node_modules/jquery/dist/jquery.min.js"></script>
        -->
        <script type="text/javascript" src="node_modules/immutable/dist/immutable.min.js"></script>
        <script type="text/javascript" src="node_modules/mithril/mithril.min.js"></script>
        <!-- required for electron -->
        <script type="text/javascript">
            window.m = require("./node_modules/mithril/mithril.min.js");
            window.$ = window.jQuery = require('./node_modules/jquery/dist/jquery.min.js');
        </script>
        <script type="text/javascript" src="node_modules/golden-layout/dist/goldenlayout.min.js"></script>
        <link type="text/css" rel="stylesheet" href="node_modules/golden-layout/src/css/goldenlayout-base.css" />
        <link type="text/css" rel="stylesheet" href="node_modules/golden-layout/src/css/default-theme.css" />

        <script type="text/javascript" src="node_modules/sibilant/lib/browser.js"></script>

        <!-- compiled sibilant
            sibilant compiled.sibilant -m -o .
        -->
        <script type="text/javascript" src="compiled.js"></script>
        <script type="text/sibilant" src="dynamic.sibilant"></script>
        <script type="text/sibilant">
        (console.log "sibilant from browser")
        </script>

        <!-- client side init -->
        <script type="text/javascript">
            /* doesn't work, although there may be a nightly that does
            $("webview").each(function(i, wv) {
                wv.addEventListener("loadstart", function(evt) {
                    console.log("started")
                })
            });
            */

        var checkjq = setInterval(function() {
            if(!$) {
                console.log('non');
                return;
            }
            clearInterval(checkjq);
            console.log($);
            $(function() {
                // sibilant preprocessor
                $("script[type$='text/sibilant']").each(function(i, el) {
                    if(el.src) {
                        try {
                            var baselen = chrome.runtime.getURL("/").length;
                        } catch(err) {
                            var baselen = path.dirname(document.baseURI).length + 1;
                        }
                        var filepath = el.src.substring(baselen);
                        console.log(filepath);
                        fs.readFile(filepath, "utf8", function(err, sibcode) {
                            if(err) {
                                console.error(err);
                                return;
                            }
                            eval(sibilant.sibilize(sibcode));
                        });
                    } else {
                        eval(sibilant.sibilize(el.innerText));
                    }
                });

                var config = {
                    content: [{
                        type: 'row',
                        content:[{
                            type: 'column',
                            content:[{
                                type: 'component',
                                componentName: 'dom-id-component',
                                componentState: { id: "inject-container" }
                            },{
                                type: 'component',
                                componentName: 'dom-component',
                                componentState: {  }
                            }]
                        },
                                 {
                                     type: 'component',
                                     componentName: 'control-component',
                                     componentState: { id: 'control-container' }
                                 }
                                ]
                    }]
                };

                var user_agent = "Mozilla/5.0 (Windows NT 6.1; WOW64; Trident/7.0; AS; rv:11.0) like Gecko";

                var control = document.createElement("div");
                control.innerHTML = "hello!";

                function resize_webviews() {
                    var wvs = document.getElementsByTagName("webview");
                    for(var i=0; i<wvs.length; ++i) {
                        var wv = wvs[i];
                        console.log(wv);
                        wv.style.width = document.documentElement.clientWidth + "px";
                        wv.style.height = document.documentElement.clientHeight + "px";
                    }
                }

                callback_cache = {};
                function register_callback(channel, func) {
                    callback_cache[channel] = function(arg) {
                        console.log("removing callback ...");
                        callback_cache[channel] = null;
                        console.log("calling callback ...");
                        func(arg);
                        console.log("done ...");
                    }
                }
                dispatcher_mapping = {};
                function ipc_event_dispatcher(evt) {
                    console.log("IPC EVENT: " + evt.channel);
                    console.log(evt.args);
                    if(callback_cache[evt.channel]) {
                        console.log("dispatching to registered callback");
                        callback_cache[evt.channel].apply(null, evt.args);
                    }
                    if(dispatcher_mapping[evt.channel]) {
                        dispatcher_mapping[evt.channel].apply(null, evt.args);
                    }
                }
                dispatcher_mapping[Const.WEBVIEW_ELEMENT_CLICK] = function(arg) {
                    window.Dynamic.exec(Const.WEBVIEW_ELEMENT_CLICK, arg);
                };

                var main_layout = new GoldenLayout(config, document.getElementById("main-container"));
                main_layout.registerComponent("control-component", function(container, componentState) {
                    container.getElement().html(document.getElementById(componentState.id));
                });
                main_layout.registerComponent("dom-component", function(container, componentState) {
                    var aux = document.createElement("webview");
                    aux.useragent = user_agent;
                    aux.autosize = "on";
                    aux.src = "https://ddg.gg";
                    aux.preload = __dirname + "/webview_preload.js";
                    console.log("====> " + aux.preload);

                    aux.addEventListener("ipc-message", ipc_event_dispatcher);
                    aux.send("get-html");

                    container.getElement().html(aux);
                });
                main_layout.registerComponent("dom-id-component", function(container, componentState) {
                    container.getElement().html(document.getElementById(componentState.id));
                });
                main_layout.init();

                $(".to-inject").show();
                $("webview").show().css({display: "flex"});

                ipcRenderer.send("ipc", "hello ipc 1");
                ipcRenderer.send("test", "hello NON-ipc 1");

                get_webview().send("get-html");
                get_webview().send("get-html", "FOO FII FI");
                get_webview().send("ipc", "foo i p c");
                get_webview().send("ipc-message", "foo i p c");

                $("#test-button").on("click", function() {
                    console.log("clicky");
                    get_webview().send("get-html");
                    ipcRenderer.sendToHost("in clicky");
                });

            });
        
        }, 50);

        </script>

        <script type="text/javascript">
        function get_webview(wv_idx) {
            wv_idx = wv_idx || 0;
            var wvs = $("webview");
            if(wvs.length == 0) {
                return;
            }
            return wvs[wv_idx];
        }

        function execjs(wv, js, cb) {
            if(!wv) { return; }
            if(wv.executeScript) {
                wv.executeScript({code:js}, cb ? cb(res) : function(res){
                    console.log(res[0])
                });
            } else if(wv.send) {
                if(cb) {
                    register_callback("chn-webview", cb);
                }
                wv.send("eval", js);
            }
        }

        function get_webview_html(wv_idx) {
            execjs(get_webview(wv_idx), "document.body.innerHTML");
        }

        function clear_webview_event_listeners(wv_idx) {
            execjs(get_webview(wv_idx), "document.body.outerHTML = document.body.outerHTML");
        }

        function attach_webview_event_listeners(wv_idx) {
            execjs(get_webview(wv_idx), "document.body.addEventListener('click', function(evt) {var csg=new CssSelectorGenerator; ipcRenderer.sendToHost('"+Const.WEBVIEW_ELEMENT_CLICK+"', csg.getSelector(evt.target))}, true)");
        }

        function javascript_handler(obj, callback) {
            console.log("%c GOT JAVASCRIPT ", "color:gray;background:gold;");
            console.log(obj);
            console.log('=============================');
            var rtn = eval.apply(null, [obj]);
            console.log('=============================');
            callback(undefined, rtn);
        }

        function sibilant_handler(obj, callback) {
            console.log("%c GOT SIBLANT ", "color:red;background:black;");
            console.log(obj);
            console.log('=============================');
            var rtn = eval.apply(null, [sibilant.sibilize(obj)]);
            console.log('=============================');
            callback(undefined, rtn);
        }

        var JRPC_PORT = 8002;

        server = null;
        function start_server() {
            if(server) {
                return;
            }
            console.log("%c check panel! ", "color:lime;font-weight:bold;background:black;");
            var jsonrpc = require('multitransport-jsonrpc');
            var Server = jsonrpc.server;
            var ServerMiddleware = jsonrpc.transports.server.middleware;
                  
            var express = require('express');
            var bodyParser = require('body-parser');
                  
            var app = express();
            app.use(bodyParser.json());
            var jsonRpcMiddlewareServer = new Server(new ServerMiddleware(), {
                javascript: javascript_handler,
                sibilant: sibilant_handler
            });
            app.use('/rpc', jsonRpcMiddlewareServer.transport.middleware);
            server = app.listen(JRPC_PORT);
        }

        function stop_server() {
            server.close();
        }

        start_server();
        </script>
    </body>
</html>
