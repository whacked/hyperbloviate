<html>
    <body>
        <style>
        * {
            margin: 0;
            padding: 0;
        }

        #main-container {
            width: 100%;
            height: 100%;
        }
        </style>

        <div id="main-container"></div>

        <!-- client side libs -->
        <script type="text/javascript" src="node_modules/jquery/dist/jquery.min.js"></script>
        <script type="text/javascript" src="node_modules/immutable/dist/immutable.min.js"></script>
        <script type="text/javascript" src="node_modules/mithril/mithril.min.js"></script>

        <script type="text/javascript" src="node_modules/w2ui/w2ui.min.js"></script>
        <link rel="stylesheet" type="text/css" href="node_modules/w2ui/w2ui.min.css">

        <script type="text/javascript" src="browser.js"></script>

        <script type="sibilant">
        (console.log "hello from sibilant")
        </script>

        <!-- client side init -->
        <script type="text/javascript">
            /* doesn't work, although there may be a nightly that does
            $("webview").each(function(i, wv) {
                wv.addEventListener("loadstart", function(evt) {
                    console.log("started")
                })
            });
            */
            $(function() {

                // sibilant preprocessor
                $("script[type$=sibilant]").each(function(i, el) {
                  eval(sibilant.sibilize(el.innerText));
                });

                var pstyle = "background-color: #F5F6F7; border: 1px solid #dfdfdf; padding: 5px;";
                $("#main-container").w2layout({
                    name: "main-layout",
                    panels: [
                    { type: 'main', style: pstyle },
                    { type: 'preview', size: '50%', resizable: true, style: pstyle },
                    { type: 'right', size: '30%', resizable: true, style: pstyle },
                    ]
                });

                var user_agent = "Mozilla/5.0 (Windows NT 6.1; WOW64; Trident/7.0; AS; rv:11.0) like Gecko";
                var main = document.createElement("webview");
                main.useragent = user_agent;
                //main.src = "./main.html";
                w2ui["main-layout"].content("main", main);

                var aux = document.createElement("webview");
                aux.useragent = user_agent;
                // aux.src = "https://ddg.gg";
                w2ui["main-layout"].content("preview", aux);

                var control = document.createElement("div");
                control.innerHTML = "hello!";
                w2ui["main-layout"].content("right", control);

            });
        </script>

        <!-- server side libs -->
        <script type="text/javascript">
            var cheerio = require("cheerio");
            var chokidar = require("chokidar");
            var domutils = require("domutils");
            var express = require("express");
            // sibilant = require("");
        </script>

        <script type="text/javascript">
        require("nw.gui").Window.get().showDevTools();

        wv = document.getElementById("main-webview");

        function execjs(js, cb) {
            wv.executeScript({code:js}, cb ? cb(res) : function(res){
                console.log(res[0])
            });
        }

        function get_webview_html() {
            execjs("document.body.innerHTML");
        }

        function clear_webview_event_listeners() {
            execjs("document.body.outerHTML = document.body.outerHTML");
        }

        function attach_webview_event_listeners() {
            execjs("document.body.addEventListener('click', function(evt) {console.log(evt)})");
        }

        function response_handler(obj, callback) {
            console.log("GOT:");
            console.log(obj);
            console.log('=============================');
            var rtn = eval(obj);
            console.log('=============================');
            callback(undefined, rtn);
        }


        app = null;
        function start_server() {
            console.log("%c check panel! ", "color:lime;font-weight:bold;background:black;");
            var jsonrpc = require('multitransport-jsonrpc');
            var Server = jsonrpc.server;
            var ServerMiddleware = jsonrpc.transports.server.middleware;
                  
            var express = require('express');
            var bodyParser = require('body-parser');
                  
            app = express();
            app.use(bodyParser.json());
            var jsonRpcMiddlewareServer = new Server(new ServerMiddleware(), {
                loopback: response_handler
            });
            app.use('/rpc', jsonRpcMiddlewareServer.transport.middleware);
            app.listen(8002);
            return app;
        }


        </script>
    </body>
</html>
